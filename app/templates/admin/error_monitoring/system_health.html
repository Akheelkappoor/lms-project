{% extends "base.html" %}

{% block title %}System Health{% endblock %}

{% block extra_css %}
<style>
    .health-card {
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
        color: white;
    }
    
    .health-excellent {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    
    .health-good {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    
    .health-warning {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        color: #333;
    }
    
    .health-critical {
        background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
    }
    
    .health-unknown {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        margin: 0;
    }
    
    .metric-label {
        opacity: 0.9;
        margin: 5px 0 0 0;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
    }
    
    .time-filter {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-excellent { background-color: #28a745; }
    .status-good { background-color: #28a745; }
    .status-warning { background-color: #ffc107; }
    .status-critical { background-color: #dc3545; }
    .status-unknown { background-color: #6c757d; }
    
    .health-history {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .health-record {
        border-left: 4px solid #28a745;
        padding: 10px;
        margin-bottom: 10px;
        background: #f8f9fa;
        border-radius: 0 4px 4px 0;
    }
    
    .health-record.warning {
        border-left-color: #ffc107;
    }
    
    .health-record.critical {
        border-left-color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard.admin_dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('error_monitoring.dashboard') }}">Error Monitoring</a></li>
                    <li class="breadcrumb-item active">System Health</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Time Filter -->
    <div class="row">
        <div class="col-12">
            <div class="time-filter">
                <h5 class="mb-3"><i class="fas fa-clock"></i> Time Range</h5>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('error_monitoring.system_health', hours=1) }}" 
                       class="btn btn-{{ 'primary' if hours == 1 else 'outline-primary' }}">
                        Last Hour
                    </a>
                    <a href="{{ url_for('error_monitoring.system_health', hours=6) }}" 
                       class="btn btn-{{ 'primary' if hours == 6 else 'outline-primary' }}">
                        Last 6 Hours
                    </a>
                    <a href="{{ url_for('error_monitoring.system_health', hours=24) }}" 
                       class="btn btn-{{ 'primary' if hours == 24 else 'outline-primary' }}">
                        Last 24 Hours
                    </a>
                    <a href="{{ url_for('error_monitoring.system_health', hours=168) }}" 
                       class="btn btn-{{ 'primary' if hours == 168 else 'outline-primary' }}">
                        Last Week
                    </a>
                </div>
                <button class="btn btn-success ml-3" onclick="refreshMetrics()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Current System Status -->
    <div class="row">
        <div class="col-12">
            <h5 class="mb-3">
                <span class="status-indicator status-{{ current_status.overall_health if current_status else 'unknown' }}"></span>
                Current System Status
                <small class="text-muted">
                    - Last updated: {{ current_status.created_at|datetime if current_status else 'Unknown' }}
                </small>
            </h5>
        </div>
    </div>

    <!-- Health Metrics Cards -->
    <div class="row">
        <div class="col-md-3">
            <div class="health-card health-{{ current_status.overall_health if current_status else 'unknown' }}">
                <h3 class="metric-value">{{ current_status.overall_health|title if current_status else 'Unknown' }}</h3>
                <p class="metric-label">Overall Health</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="health-card health-{{ 'critical' if current_status and current_status.cpu_usage > 90 else 'warning' if current_status and current_status.cpu_usage > 70 else 'good' }}">
                <h3 class="metric-value">{{ "%.1f"|format(current_status.cpu_usage) if current_status else '0' }}%</h3>
                <p class="metric-label">CPU Usage</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="health-card health-{{ 'critical' if current_status and current_status.memory_usage > 90 else 'warning' if current_status and current_status.memory_usage > 70 else 'good' }}">
                <h3 class="metric-value">{{ "%.1f"|format(current_status.memory_usage) if current_status else '0' }}%</h3>
                <p class="metric-label">Memory Usage</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="health-card health-{{ 'critical' if current_status and current_status.error_rate > 10 else 'warning' if current_status and current_status.error_rate > 5 else 'good' }}">
                <h3 class="metric-value">{{ "%.2f"|format(current_status.error_rate) if current_status else '0' }}%</h3>
                <p class="metric-label">Error Rate</p>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-chart-line"></i> CPU & Memory Usage</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="systemMetricsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Error Rate Over Time</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="errorRateChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Services Status -->
    <div class="row mt-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-server"></i> System Services</h6>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <span class="status-indicator status-good"></span>
                                Database Connection
                            </span>
                            <span class="badge badge-success">Online</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <span class="status-indicator status-good"></span>
                                Web Server
                            </span>
                            <span class="badge badge-success">Running</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <span class="status-indicator status-warning"></span>
                                Email Service
                            </span>
                            <span class="badge badge-warning">Limited</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <span class="status-indicator status-good"></span>
                                File System
                            </span>
                            <span class="badge badge-success">Available</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-history"></i> Health History</h6>
                </div>
                <div class="card-body">
                    <div class="health-history">
                        {% if health_metrics %}
                            {% for metric in health_metrics[-10:] %}
                            <div class="health-record {{ 'critical' if metric.overall_health == 'critical' else 'warning' if metric.overall_health == 'warning' else '' }}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ metric.overall_health|title }}</strong>
                                        <br>
                                        <small class="text-muted">
                                            CPU: {{ "%.1f"|format(metric.cpu_usage) }}% | 
                                            Memory: {{ "%.1f"|format(metric.memory_usage) }}% | 
                                            Errors: {{ "%.2f"|format(metric.error_rate) }}%
                                        </small>
                                    </div>
                                    <small class="text-muted">{{ metric.created_at|datetime }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-history fa-2x mb-2"></i>
                            <p>No health history available</p>
                            <small>System health metrics will appear here over time</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Recommendations -->
    {% if current_status %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Performance Recommendations</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% if current_status.cpu_usage > 80 %}
                        <div class="col-md-6">
                            <div class="alert alert-warning">
                                <i class="fas fa-microchip"></i>
                                <strong>High CPU Usage</strong>
                                <p class="mb-0">Consider optimizing database queries or scaling server resources.</p>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if current_status.memory_usage > 80 %}
                        <div class="col-md-6">
                            <div class="alert alert-warning">
                                <i class="fas fa-memory"></i>
                                <strong>High Memory Usage</strong>
                                <p class="mb-0">Review memory-intensive processes and consider increasing RAM.</p>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if current_status.error_rate > 5 %}
                        <div class="col-md-6">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>High Error Rate</strong>
                                <p class="mb-0">Investigate recent errors and implement fixes to improve stability.</p>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if current_status.cpu_usage <= 80 and current_status.memory_usage <= 80 and current_status.error_rate <= 5 %}
                        <div class="col-12">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i>
                                <strong>System Performance is Good</strong>
                                <p class="mb-0">All metrics are within healthy ranges. Continue monitoring for optimal performance.</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Health metrics data will be populated from server data
const healthMetricsData = [];

document.addEventListener('DOMContentLoaded', function() {
    // System Metrics Chart
    const systemCtx = document.getElementById('systemMetricsChart').getContext('2d');
    
    const labels = [];
    const cpuData = [];
    const memoryData = [];
    
    {% if health_metrics %}
    {% for metric in health_metrics %}
    labels.push('{{ metric.created_at|datetime }}');
    cpuData.push({{ metric.cpu_usage }});
    memoryData.push({{ metric.memory_usage }});
    {% endfor %}
    {% endif %}
    
    new Chart(systemCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'CPU Usage (%)',
                data: cpuData,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4
            }, {
                label: 'Memory Usage (%)',
                data: memoryData,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
    
    // Error Rate Chart
    const errorCtx = document.getElementById('errorRateChart').getContext('2d');
    
    const errorRateData = [];
    {% if health_metrics %}
    {% for metric in health_metrics %}
    errorRateData.push({{ metric.error_rate }});
    {% endfor %}
    {% endif %}
    
    new Chart(errorCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Error Rate (%)',
                data: errorRateData,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
});

function refreshMetrics() {
    // Add loading indicator
    const refreshBtn = document.querySelector('button[onclick="refreshMetrics()"]');
    const originalText = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    refreshBtn.disabled = true;
    
    // Refresh the page after a short delay to simulate metric collection
    setTimeout(() => {
        location.reload();
    }, 1000);
}
</script>
{% endblock %}