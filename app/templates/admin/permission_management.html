{% extends "base.html" %}
{% block title %}Advanced Permission Management - {{ APP_NAME }}{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">
                <i class="fas fa-shield-alt"></i>
                Advanced Permission Management
            </h1>
            <p class="page-subtitle">Control what each department can do in the system</p>
        </div>
        <div class="header-actions">
            <a href="{{ url_for('admin.departments') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to Departments
            </a>
        </div>
    </div>
</div>

<div class="container-fluid mt-4">
    <!-- DEPARTMENT SELECTOR -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-building me-2"></i>
                        Select Department to Manage
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <label class="form-label">Choose Department:</label>
                            <select class="form-select form-select-lg" id="departmentSelector" onchange="changeDepartment()">
                                {% for dept in departments %}
                                <option value="{{ dept.id }}" {% if dept.id == department.id %}selected{% endif %}>
                                    {{ dept.code }} - {{ dept.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex flex-column">
                                <div class="mb-2">
                                    <span class="badge badge-{{ department.permission_level or 'medium' }} badge-lg">
                                        <i class="fas fa-layer-group me-1"></i>
                                        {{ (department.permission_level or 'Medium').title() }} Level Department
                                    </span>
                                </div>
                                <div>
                                    <span class="badge badge-info badge-lg">
                                        <i class="fas fa-key me-1"></i>
                                        {{ current_permissions|length }} Permissions Active
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CURRENT DEPARTMENT INFO -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle text-primary"></i>
                        {{ department.name }} - Permission Management
                    </h5>
                    <div class="d-flex gap-2">
                        <span class="badge badge-{{ department.permission_level or 'medium' }}">
                            {{ (department.permission_level or 'Medium').title() }} Level Department
                        </span>
                        <span class="badge badge-info">
                            {{ current_permissions|length }} Permissions Active
                        </span>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Department Stats -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card text-center p-3 bg-light rounded">
                                <h5 class="text-primary">{{ department.get_user_count() if department.get_user_count else 0 }}</h5>
                                <small>Total Users</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center p-3 bg-light rounded">
                                <h5 class="text-success">{{ department.get_coordinator_count() if department.get_coordinator_count else 0 }}</h5>
                                <small>Coordinators</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center p-3 bg-light rounded">
                                <h5 class="text-info">{{ department.get_tutor_count() if department.get_tutor_count else 0 }}</h5>
                                <small>Tutors</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center p-3 bg-light rounded">
                                <h5 class="text-warning">{{ department.get_student_count() if department.get_student_count else 0 }}</h5>
                                <small>Students</small>
                            </div>
                        </div>
                    </div>

                    <!-- Permission Form -->
                    <form method="POST" id="permissionForm" action="{{ url_for('admin.department_permissions', dept_id=department.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        
                        <div class="mb-3">
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="selectAll()">
                                    <i class="fas fa-check-double"></i> Select All
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearAll()">
                                    <i class="fas fa-times"></i> Clear All
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="selectRecommended()">
                                    <i class="fas fa-star"></i> Recommended for {{ department.code }}
                                </button>
                            </div>
                        </div>

                        <!-- Permissions by Category -->
                        {% for category, permissions in permission_categories.items() %}
                        <div class="permission-category mb-4">
                            <div class="category-header d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">
                                    <i class="fas fa-folder text-primary"></i>
                                    {{ category }}
                                </h5>
                                <small class="text-muted">{{ permissions|length }} permissions</small>
                            </div>
                            
                            <div class="row">
                                {% for permission in permissions %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="permission-card p-3 border rounded {% if permission.key in current_permissions %}border-success bg-light{% endif %}">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="permissions" value="{{ permission.key }}" 
                                                   id="{{ permission.key }}"
                                                   {% if permission.key in current_permissions %}checked{% endif %}>
                                            <label class="form-check-label w-100" for="{{ permission.key }}">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <strong>{{ permission.name }}</strong>
                                                        <br>
                                                        <small class="text-muted">{{ permission.description }}</small>
                                                    </div>
                                                    <span class="badge badge-{{ 'danger' if permission.level == 'high' else 'warning' if permission.level == 'medium' else 'success' }}">
                                                        {{ permission.level }}
                                                    </span>
                                                </div>
                                                <div class="mt-2">
                                                    <small class="text-info">
                                                        <i class="fas fa-route"></i>
                                                        Controls {{ permission.routes_count }} routes
                                                    </small>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}

                        <!-- Submit Button -->
                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <div>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Changes will affect all coordinators in this department
                                </small>
                            </div>
                            <div>
                                <a href="{{ url_for('admin.departments') }}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Back
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Update Permissions
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Active Permissions Panel -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list"></i> Current Active Permissions for {{ department.name }}</h5>
                </div>
                <div class="card-body">
                    {% if current_permissions %}
                        <div class="row">
                            {% for permission in current_permissions %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card border-left-primary">
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <strong>{{ permission|replace('_', ' ')|title }}</strong>
                                                <br>
                                                <small class="text-muted">Active Permission</small>
                                            </div>
                                            <span class="badge badge-success">
                                                <i class="fas fa-check"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                            <h5>No Permissions Set</h5>
                            <p class="text-muted">This department has no permissions configured. Select permissions above to grant access.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.permission-card {
    transition: all 0.3s ease;
    cursor: pointer;
}

.permission-card:hover {
    border-color: #007bff !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.permission-card input:checked + label {
    color: #28a745;
}

.stat-card {
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.category-header {
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.5rem;
}

.border-left-primary {
    border-left: 4px solid #007bff !important;
}

.badge-lg {
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
}

.badge-danger {
    background-color: #dc3545;
}

.badge-warning {
    background-color: #ffc107;
    color: #212529;
}

.badge-success {
    background-color: #28a745;
}

.badge-info {
    background-color: #17a2b8;
}

.badge-medium {
    background-color: #6c757d;
}

.badge-high {
    background-color: #dc3545;
}

.badge-low {
    background-color: #28a745;
}
</style>

<script>
// Department selector function
function changeDepartment() {
    const selector = document.getElementById('departmentSelector');
    const selectedDeptId = selector.value;
    if (selectedDeptId) {
        window.location.href = `/admin/permission-management/${selectedDeptId}`;
    }
}

function selectAll() {
    document.querySelectorAll('input[name="permissions"]').forEach(cb => cb.checked = true);
    updateCardStyles();
}

function clearAll() {
    document.querySelectorAll('input[name="permissions"]').forEach(cb => cb.checked = false);
    updateCardStyles();
}

function selectRecommended() {
    // Define recommended permissions for each department type
    const recommended = {
        'K12': ['student_management', 'tutor_management', 'class_management', 'attendance_management', 'notice_management'],
        'TT': ['student_management', 'tutor_management', 'class_management', 'report_generation', 'system_documents'],
        'UPSKILL': ['student_management', 'class_management', 'attendance_management', 'notice_management'],
        'MATH': ['student_management', 'tutor_management', 'class_management', 'attendance_management'],
        'SCI': ['student_management', 'tutor_management', 'class_management', 'attendance_management'],
        'ENG': ['student_management', 'tutor_management', 'class_management', 'attendance_management']
    };
    
    const deptCode = '{{ department.code }}';
    const recommendedPerms = recommended[deptCode] || ['student_management', 'tutor_management', 'class_management'];
    
    document.querySelectorAll('input[name="permissions"]').forEach(cb => {
        cb.checked = recommendedPerms.includes(cb.value);
    });
    updateCardStyles();
}

function updateCardStyles() {
    document.querySelectorAll('input[name="permissions"]').forEach(cb => {
        const card = cb.closest('.permission-card');
        if (cb.checked) {
            card.classList.add('border-success', 'bg-light');
        } else {
            card.classList.remove('border-success', 'bg-light');
        }
    });
}

// Add event listeners to checkboxes
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input[name="permissions"]').forEach(cb => {
        cb.addEventListener('change', updateCardStyles);
    });
    
    // Handle form submission
    document.getElementById('permissionForm').addEventListener('submit', function(e) {
        const selected = document.querySelectorAll('input[name="permissions"]:checked').length;
        if (selected === 0) {
            if (!confirm('No permissions selected. This will remove all permissions from the department. Continue?')) {
                e.preventDefault();
            }
        }
        
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        submitBtn.disabled = true;
    });
    
    // Initialize card styles
    updateCardStyles();
});
</script>
{% endblock %}