{% extends "base.html" %}

{% block title %}Register New Student{% endblock %}

{% block extra_css %}
<style>
    /* Reset and eliminate gaps */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    /* Main content takes full available width */
    .main-content {
        flex: 1;
        width: 100%;
        max-width: none;
        padding: 0;
        margin: 0;
        background: #ffffff;
    }

    /* Page content wrapper */
    .page-content {
        padding: 1.5rem;
        width: 100%;
    }
    
    .registration-container {
        width: 100%;
        max-width: none;
        margin: 0;
        padding: 0;
    }

    /* Enhanced Form Error Display */
    .form-errors-summary {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        display: none;
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }

    .form-errors-summary.show {
        display: block;
        animation: slideDown 0.5s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .form-errors-summary h4 {
        margin: 0 0 1rem 0;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-errors-summary ul {
        margin: 0;
        padding-left: 1.5rem;
    }

    .form-errors-summary li {
        margin-bottom: 0.5rem;
        line-height: 1.4;
    }
    
    .form-section {
        background: #ffffff;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        border: 1px solid #e9ecef;
        width: 100%;
    }
    
    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #e9ecef;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
        width: 100%;
    }
    
    .form-row.triple {
        grid-template-columns: 1fr 1fr 1fr;
    }
    
    .form-row.single {
        grid-template-columns: 1fr;
    }
    
    .form-group {
        width: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .form-group label {
        display: block;
        font-weight: 500;
        color: #2c3e50;
        margin-bottom: 0.5rem;
        width: 100%;
    }
    
    .form-control {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 0.875rem;
        transition: all 0.3s ease;
        background: #ffffff;
        box-sizing: border-box;
    }
    
    .form-control.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        background-color: rgba(220, 53, 69, 0.02);
    }

    .form-control.is-valid {
        border-color: #28a745;
        box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        background-color: rgba(40, 167, 69, 0.02);
    }
    
    /* Enhanced Error Display */
    .invalid-feedback {
        color: #dc3545;
        font-size: 0.8rem;
        margin-top: 0.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .invalid-feedback::before {
        content: '\f071';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    
    .form-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
    }
    
    .required {
        color: #dc3545;
    }
    
    .help-text {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    /* Enhanced File Upload */
    .file-upload-area {
        border: 2px dashed #e9ecef;
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
        background: #f8f9fa;
        width: 100%;
        box-sizing: border-box;
        cursor: pointer;
        position: relative;
    }
    
    .file-upload-area:hover {
        border-color: #007bff;
        background: rgba(0, 123, 255, 0.05);
    }

    .file-upload-area.has-error {
        border-color: #dc3545;
        background: rgba(220, 53, 69, 0.05);
    }

    .file-upload-area.has-file {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.05);
    }
    
    .file-upload-icon {
        font-size: 2rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }

    .file-upload-area.has-file .file-upload-icon {
        color: #28a745;
    }

    .file-upload-area.has-error .file-upload-icon {
        color: #dc3545;
    }

    .file-upload-area input[type="file"] {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    .file-upload-area p {
        margin: 0;
        color: #6c757d;
        font-size: 0.9rem;
    }

    .file-info {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.5rem;
        font-style: italic;
    }
    
    .form-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        padding-top: 2rem;
        border-top: 1px solid #e9ecef;
        margin-top: 2rem;
        width: 100%;
    }
    
    .btn-group {
        display: flex;
        gap: 1rem;
    }
    
    .progress-indicator {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 2rem;
        gap: 1rem;
        width: 100%;
    }
    
    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        opacity: 0.5;
        transition: all 0.3s ease;
    }
    
    .progress-step.active {
        opacity: 1;
    }
    
    .progress-step.completed {
        opacity: 1;
        color: #28a745;
    }
    
    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        background: #ffffff;
    }
    
    .step-circle.active {
        border-color: #007bff;
        background: #007bff;
        color: white;
    }
    
    .step-circle.completed {
        border-color: #28a745;
        background: #28a745;
        color: white;
    }
    
    /* Hide form steps by default */
    .form-step {
        display: none;
        width: 100%;
    }
    
    .form-step.active {
        display: block;
    }
    
    /* Button styles */
    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .btn-primary:hover {
        background: #0056b3;
        border-color: #0056b3;
        transform: translateY(-1px);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }
    
    .btn-outline {
        background: transparent;
        color: #007bff;
        border-color: #007bff;
    }
    
    .btn-outline:hover {
        background: #007bff;
        color: white;
        transform: translateY(-1px);
    }
    
    /* Page header styles */
    .page-header {
        width: 100%;
        margin-bottom: 2rem;
        padding: 0;
    }
    
    .page-header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .page-title h1 {
        margin: 0;
        color: #2c3e50;
        font-size: 1.75rem;
    }
    
    .page-title p {
        margin: 0.5rem 0 0 0;
        color: #6c757d;
        font-size: 1rem;
    }
    
    /* Override any base template styles that might cause gaps */
    .container-fluid,
    .container {
        padding: 0 !important;
        margin: 0 !important;
        max-width: none !important;
        width: 100% !important;
    }
    
    /* Responsive design */
    @media (max-width: 1024px) {
        .form-row.triple {
            grid-template-columns: 1fr 1fr;
        }
    }
    
    @media (max-width: 768px) {
        .page-content {
            padding: 1rem;
        }
        
        .registration-container {
            padding: 0;
        }
        
        .form-section {
            padding: 1.5rem;
        }
        
        .form-row, .form-row.triple {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .form-actions {
            flex-direction: column;
            align-items: stretch;
        }
        
        .btn-group {
            justify-content: center;
        }
        
        .progress-indicator {
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .page-header-content {
            flex-direction: column;
            align-items: stretch;
        }
    }
    
    @media (max-width: 480px) {
        .page-content {
            padding: 0.75rem;
        }
        
        .progress-step {
            font-size: 0.75rem;
        }
        
        .step-circle {
            width: 35px;
            height: 35px;
            font-size: 0.875rem;
        }
        
        .form-section {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-content">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-content">
            <div class="page-title">
                <h1><i class="fas fa-user-plus"></i> Register New Student</h1>
                <p>Complete student registration with all required information</p>
            </div>
            <div class="page-actions">
                <a href="{{ url_for('admin.students') }}" class="btn btn-outline">
                    <i class="fas fa-arrow-left"></i> Back to Students
                </a>
            </div>
        </div>
    </div>

    <div class="registration-container">
        <!-- Form Errors Summary -->
        <div id="formErrorsSummary" class="form-errors-summary">
            <h4><i class="fas fa-exclamation-triangle"></i> Please fix the following errors:</h4>
            <ul id="errorsList"></ul>
        </div>

        <!-- Progress Indicator -->
        <div class="progress-indicator">
            <div class="progress-step active" data-step="1">
                <div class="step-circle active">1</div>
                <span>Student Info</span>
            </div>
            <div class="progress-step" data-step="2">
                <div class="step-circle">2</div>
                <span>Academic & Fees</span>
            </div>
            <div class="progress-step" data-step="3">
                <div class="step-circle">3</div>
                <span>Parents</span>
            </div>
            <div class="progress-step" data-step="4">
                <div class="step-circle">4</div>
                <span>Profile & Docs</span>
            </div>
        </div>

        <form method="POST" enctype="multipart/form-data" id="studentRegistrationForm" novalidate>
            {{ form.hidden_tag() }}
            
            <!-- Step 1: Student Information -->
            <div class="form-step active" data-step="1">
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-user"></i>
                        Student Information
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.full_name.label(class="form-label") }} <span class="required">*</span>
                            {{ form.full_name(class="form-control", required=true) }}
                            {% if form.full_name.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.full_name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            {{ form.email.label(class="form-label") }} <span class="required">*</span>
                            {{ form.email(class="form-control", required=true) }}
                            {% if form.email.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.email.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.phone.label(class="form-label") }}
                            {{ form.phone(class="form-control") }}
                            {% if form.phone.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.phone.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            {{ form.date_of_birth.label(class="form-label") }} <span class="required">*</span>
                            {{ form.date_of_birth(class="form-control", required=true) }}
                            {% if form.date_of_birth.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.date_of_birth.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="form-row single">
                        <div class="form-group">
                            {{ form.address.label(class="form-label") }} <span class="required">*</span>
                            {{ form.address(class="form-control", rows="3", required=true) }}
                            {% if form.address.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.address.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.state.label(class="form-label") }} <span class="required">*</span>
                            {{ form.state(class="form-control", required=true) }}
                            {% if form.state.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.state.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            {{ form.pin_code.label(class="form-label") }} <span class="required">*</span>
                            {{ form.pin_code(class="form-control", required=true) }}
                            {% if form.pin_code.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.pin_code.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Academic Information & Fee Structure -->
            <div class="form-step" data-step="2">
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-graduation-cap"></i>
                        Academic Information
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.grade.label(class="form-label") }} <span class="required">*</span>
                            {{ form.grade(class="form-control", required=true) }}
                            {% if form.grade.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.grade.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="help-text">e.g., 5, 10, 12, PG</div>
                        </div>
                        
                        <div class="form-group">
                            {{ form.board.label(class="form-label") }} <span class="required">*</span>
                            {{ form.board(class="form-control", required=true) }}
                            {% if form.board.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.board.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="help-text">e.g., CBSE, ICSE, State Board</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.school_name.label(class="form-label") }} <span class="required">*</span>
                            {{ form.school_name(class="form-control", required=true) }}
                            {% if form.school_name.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.school_name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            {{ form.academic_year.label(class="form-label") }} <span class="required">*</span>
                            {{ form.academic_year(class="form-control", required=true) }}
                            {% if form.academic_year.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.academic_year.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="help-text">e.g., 2024-25</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.course_start_date.label(class="form-label") }} <span class="required">*</span>
                            {{ form.course_start_date(class="form-control", required=true) }}
                            {% if form.course_start_date.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.course_start_date.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            {{ form.department_id.label(class="form-label") }} <span class="required">*</span>
                            {{ form.department_id(class="form-control form-select", required=true) }}
                            {% if form.department_id.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.department_id.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.subjects_enrolled.label(class="form-label") }} <span class="required">*</span>
                            {{ form.subjects_enrolled(class="form-control", required=true) }}
                            {% if form.subjects_enrolled.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.subjects_enrolled.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="help-text">Comma-separated list of subjects</div>
                        </div>
                        
                        <div class="form-group">
                            {{ form.relationship_manager.label(class="form-label") }}
                            {{ form.relationship_manager(class="form-control") }}
                            {% if form.relationship_manager.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.relationship_manager.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="help-text">Assigned sales person or relationship manager</div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-rupee-sign"></i>
                        Fee Structure
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.total_fee.label(class="form-label") }} <span class="required">*</span>
                            {{ form.total_fee(class="form-control", required=true) }}
                            {% if form.total_fee.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.total_fee.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            {{ form.amount_paid.label(class="form-label") }}
                            {{ form.amount_paid(class="form-control") }}
                            {% if form.amount_paid.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.amount_paid.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="help-text">Leave empty if no payment made yet</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.payment_mode.label(class="form-label") }} <span class="required">*</span>
                            {{ form.payment_mode(class="form-control form-select", required=true) }}
                            {% if form.payment_mode.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.payment_mode.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            {{ form.payment_schedule.label(class="form-label") }} <span class="required">*</span>
                            {{ form.payment_schedule(class="form-control form-select", required=true) }}
                            {% if form.payment_schedule.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.payment_schedule.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Parent/Guardian Information -->
            <div class="form-step" data-step="3">
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-users"></i>
                        Father's Information
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.father_name.label(class="form-label") }} <span class="required">*</span>
                            {{ form.father_name(class="form-control", required=true) }}
                            {% if form.father_name.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.father_name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            {{ form.father_phone.label(class="form-label") }} <span class="required">*</span>
                            {{ form.father_phone(class="form-control", required=true) }}
                            {% if form.father_phone.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.father_phone.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.father_email.label(class="form-label") }}
                            {{ form.father_email(class="form-control") }}
                            {% if form.father_email.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.father_email.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            {{ form.father_profession.label(class="form-label") }}
                            {{ form.father_profession(class="form-control") }}
                            {% if form.father_profession.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.father_profession.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="form-row single">
                        <div class="form-group">
                            {{ form.father_workplace.label(class="form-label") }}
                            {{ form.father_workplace(class="form-control") }}
                            {% if form.father_workplace.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.father_workplace.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-female"></i>
                        Mother's Information
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.mother_name.label(class="form-label") }} <span class="required">*</span>
                            {{ form.mother_name(class="form-control", required=true) }}
                            {% if form.mother_name.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.mother_name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            {{ form.mother_phone.label(class="form-label") }}
                            {{ form.mother_phone(class="form-control") }}
                            {% if form.mother_phone.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.mother_phone.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.mother_email.label(class="form-label") }}
                            {{ form.mother_email(class="form-control") }}
                            {% if form.mother_email.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.mother_email.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            {{ form.mother_profession.label(class="form-label") }}
                            {{ form.mother_profession(class="form-control") }}
                            {% if form.mother_profession.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.mother_profession.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="form-row single">
                        <div class="form-group">
                            {{ form.mother_workplace.label(class="form-label") }}
                            {{ form.mother_workplace(class="form-control") }}
                            {% if form.mother_workplace.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.mother_workplace.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Academic Profile & Documents -->
            <div class="form-step" data-step="4">
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-user-circle"></i>
                        Academic Profile
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.siblings.label(class="form-label") }}
                            {{ form.siblings(class="form-control") }}
                            {% if form.siblings.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.siblings.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            {{ form.favorite_subjects.label(class="form-label") }}
                            {{ form.favorite_subjects(class="form-control") }}
                            {% if form.favorite_subjects.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.favorite_subjects.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="help-text">Comma-separated list</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.difficult_subjects.label(class="form-label") }}
                            {{ form.difficult_subjects(class="form-control") }}
                            {% if form.difficult_subjects.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.difficult_subjects.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="help-text">Areas needing extra attention</div>
                        </div>
                        
                        <div class="form-group">
                            {{ form.hobbies.label(class="form-label") }}
                            {{ form.hobbies(class="form-control") }}
                            {% if form.hobbies.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.hobbies.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="help-text">Comma-separated list</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.learning_styles.label(class="form-label") }}
                            {{ form.learning_styles(class="form-control") }}
                            {% if form.learning_styles.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.learning_styles.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="help-text">Visual, Auditory, Kinesthetic, etc.</div>
                        </div>
                        
                        <div class="form-group">
                            {{ form.learning_patterns.label(class="form-label") }}
                            {{ form.learning_patterns(class="form-control") }}
                            {% if form.learning_patterns.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.learning_patterns.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="help-text">Fast learner, Needs repetition, etc.</div>
                        </div>
                    </div>
                    
                    <div class="form-row single">
                        <div class="form-group">
                            {{ form.parent_feedback.label(class="form-label") }}
                            {{ form.parent_feedback(class="form-control", rows="3") }}
                            {% if form.parent_feedback.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.parent_feedback.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="help-text">Previous tutoring experience, learning challenges, etc.</div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-file-alt"></i>
                        Document Uploads
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.marksheet.label(class="form-label") }}
                            <div class="file-upload-area" data-field="marksheet">
                                <div class="file-upload-icon">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                {{ form.marksheet(class="form-control", accept=".jpg,.jpeg,.png,.pdf") }}
                                <p>Upload Previous Year's Mark Sheet</p>
                                <div class="file-info">Max size: 5MB | Formats: JPG, PNG, PDF</div>
                            </div>
                            {% if form.marksheet.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.marksheet.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            {{ form.student_aadhaar.label(class="form-label") }}
                            <div class="file-upload-area" data-field="student_aadhaar">
                                <div class="file-upload-icon">
                                    <i class="fas fa-id-card"></i>
                                </div>
                                {{ form.student_aadhaar(class="form-control", accept=".jpg,.jpeg,.png,.pdf") }}
                                <p>Upload Student Aadhaar Card</p>
                                <div class="file-info">Max size: 5MB | Formats: JPG, PNG, PDF</div>
                            </div>
                            {% if form.student_aadhaar.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.student_aadhaar.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="form-row single">
                        <div class="form-group">
                            {{ form.school_id.label(class="form-label") }}
                            <div class="file-upload-area" data-field="school_id">
                                <div class="file-upload-icon">
                                    <i class="fas fa-school"></i>
                                </div>
                                {{ form.school_id(class="form-control", accept=".jpg,.jpeg,.png,.pdf") }}
                                <p>Upload School ID (if available)</p>
                                <div class="file-info">Max size: 5MB | Formats: JPG, PNG, PDF</div>
                            </div>
                            {% if form.school_id.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.school_id.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <div class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    All fields marked with <span class="required">*</span> are required
                </div>
                
                <div class="btn-group">
                    <button type="button" class="btn btn-outline" id="prevBtn" style="display: none;">
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <button type="button" class="btn btn-primary" id="nextBtn">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                    {{ form.submit(class="btn btn-primary", id="submitBtn", style="display: none;") }}
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== STUDENT REGISTRATION FORM INITIALIZED ===');
    
    let currentStep = 1;
    const totalSteps = 4;
    
    // Elements
    const form = document.getElementById('studentRegistrationForm');
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    const submitBtn = document.getElementById('submitBtn');
    const errorsSummary = document.getElementById('formErrorsSummary');
    const errorsList = document.getElementById('errorsList');
    
    // File validation rules
    const fileValidation = {
        marksheet: {
            types: ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'],
            maxSize: 5 * 1024 * 1024, // 5MB
            extensions: ['.jpg', '.jpeg', '.png', '.pdf']
        },
        student_aadhaar: {
            types: ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'],
            maxSize: 5 * 1024 * 1024, // 5MB
            extensions: ['.jpg', '.jpeg', '.png', '.pdf']
        },
        school_id: {
            types: ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'],
            maxSize: 5 * 1024 * 1024, // 5MB
            extensions: ['.jpg', '.jpeg', '.png', '.pdf']
        }
    };

    // Step management
    function showStep(step) {
        // Hide all steps
        document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.progress-step').forEach(s => {
            s.classList.remove('active');
            s.querySelector('.step-circle').classList.remove('active');
        });
        
        // Show current step
        document.querySelector(`.form-step[data-step="${step}"]`).classList.add('active');
        const progressStep = document.querySelector(`.progress-step[data-step="${step}"]`);
        progressStep.classList.add('active');
        progressStep.querySelector('.step-circle').classList.add('active');
        
        // Mark completed steps
        for (let i = 1; i < step; i++) {
            const completedStep = document.querySelector(`.progress-step[data-step="${i}"]`);
            completedStep.classList.add('completed');
            completedStep.querySelector('.step-circle').classList.add('completed');
        }
        
        // Update navigation buttons
        prevBtn.style.display = step === 1 ? 'none' : 'inline-flex';
        nextBtn.style.display = step === totalSteps ? 'none' : 'inline-flex';
        submitBtn.style.display = step === totalSteps ? 'inline-flex' : 'none';
        
        // Hide errors summary when navigating steps
        errorsSummary.classList.remove('show');
    }
    
    // Enhanced step validation
    function validateStep(step) {
        const stepElement = document.querySelector(`.form-step[data-step="${step}"]`);
        let isValid = true;
        const errors = [];
        
        // Check required fields (marked with required asterisk)
        stepElement.querySelectorAll('.required').forEach(asterisk => {
            const formGroup = asterisk.closest('.form-group');
            if (formGroup) {
                const input = formGroup.querySelector('input, select, textarea');
                const label = formGroup.querySelector('label');
                const fieldName = label ? label.textContent.replace(' *', '').trim() : input?.name || 'Field';
                
                if (input && input.type === 'file') {
                    // File field validation
                    if (!input.files || input.files.length === 0) {
                        isValid = false;
                        errors.push(`${fieldName} is required`);
                        input.classList.add('is-invalid');
                        input.closest('.file-upload-area')?.classList.add('has-error');
                    }
                } else if (input && !input.value.trim()) {
                    isValid = false;
                    errors.push(`${fieldName} is required`);
                    input.classList.add('is-invalid');
                } else if (input) {
                    input.classList.remove('is-invalid');
                    input.closest('.file-upload-area')?.classList.remove('has-error');
                }
            }
        });
        
        // Email validation
        const emailFields = stepElement.querySelectorAll('input[type="email"]');
        emailFields.forEach(email => {
            if (email.value.trim()) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email.value)) {
                    isValid = false;
                    errors.push('Please enter a valid email address');
                    email.classList.add('is-invalid');
                }
            }
        });
        
        return { isValid, errors };
    }
    
    // Enhanced file upload handling
    function setupFileUploads() {
        const fileInputs = document.querySelectorAll('input[type="file"]');
        
        fileInputs.forEach(input => {
            const uploadArea = input.closest('.file-upload-area');
            if (!uploadArea) return;
            
            input.addEventListener('change', function(e) {
                const fieldName = this.name;
                const validation = fileValidation[fieldName];
                
                // Clear previous states
                uploadArea.classList.remove('has-error', 'has-file');
                this.classList.remove('is-invalid', 'is-valid');
                
                // Remove existing error messages
                const existingError = uploadArea.parentNode.querySelector('.invalid-feedback.js-error');
                if (existingError) {
                    existingError.remove();
                }
                
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    let isValid = true;
                    let errorMessage = '';
                    
                    // Validate file type
                    if (validation && !validation.types.includes(file.type)) {
                        const ext = '.' + file.name.split('.').pop().toLowerCase();
                        if (!validation.extensions.includes(ext)) {
                            isValid = false;
                            errorMessage = `Invalid file type. Allowed: ${validation.extensions.join(', ')}`;
                        }
                    }
                    
                    // Validate file size
                    if (validation && file.size > validation.maxSize) {
                        isValid = false;
                        const maxSizeMB = (validation.maxSize / (1024 * 1024)).toFixed(0);
                        errorMessage = `File too large. Max size: ${maxSizeMB}MB`;
                    }
                    
                    if (isValid) {
                        // File is valid
                        updateFileDisplay(input, file, true);
                    } else {
                        // File is invalid
                        updateFileDisplay(input, file, false, errorMessage);
                    }
                }
            });
        });
    }
    
    function updateFileDisplay(input, file, isValid, errorMessage = '') {
        const uploadArea = input.closest('.file-upload-area');
        const icon = uploadArea.querySelector('.file-upload-icon i');
        const text = uploadArea.querySelector('p');
        
        if (isValid) {
            uploadArea.classList.add('has-file');
            input.classList.add('is-valid');
            icon.className = 'fas fa-check-circle';
            icon.style.color = '#28a745';
            text.textContent = ` Selected: ${file.name}`;
            text.style.color = '#28a745';
        } else {
            uploadArea.classList.add('has-error');
            input.classList.add('is-invalid');
            icon.className = 'fas fa-exclamation-triangle';
            icon.style.color = '#dc3545';
            text.textContent = ` ${errorMessage}`;
            text.style.color = '#dc3545';
            
            // Add error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback js-error';
            errorDiv.textContent = errorMessage;
            uploadArea.parentNode.appendChild(errorDiv);
            
            // Clear the invalid file
            input.value = '';
        }
    }
    
    // Event listeners
    nextBtn.addEventListener('click', function() {
        const validation = validateStep(currentStep);
        
        if (validation.isValid) {
            currentStep++;
            showStep(currentStep);
        } else {
            // Show errors
            errorsList.innerHTML = validation.errors.map(error => `<li>${error}</li>`).join('');
            errorsSummary.classList.add('show');
            errorsSummary.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });
    
    prevBtn.addEventListener('click', function() {
        currentStep--;
        showStep(currentStep);
    });
    
    // Enhanced form submission
    form.addEventListener('submit', function(e) {
        console.log('=== FORM SUBMISSION STARTED ===');
        
        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registering...';
        
        // Validate all steps
        let allErrors = [];
        let hasErrors = false;
        
        for (let step = 1; step <= totalSteps; step++) {
            const validation = validateStep(step);
            if (!validation.isValid) {
                hasErrors = true;
                allErrors = allErrors.concat(validation.errors.map(error => `Step ${step}: ${error}`));
            }
        }
        
        // Check for file validation errors
        const fileInputs = document.querySelectorAll('input[type="file"]');
        let hasFileErrors = false;
        fileInputs.forEach(input => {
            if (input.classList.contains('is-invalid')) {
                hasFileErrors = true;
            }
        });
        
        if (hasFileErrors) {
            allErrors.push('Please fix file upload errors');
        }
        
        if (hasErrors || hasFileErrors) {
            console.log('=== VALIDATION ERRORS ===', allErrors);
            
            // Show errors summary
            errorsList.innerHTML = allErrors.map(error => `<li>${error}</li>`).join('');
            errorsSummary.classList.add('show');
            errorsSummary.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Register Student';
            
            // Go to first step with errors
            for (let step = 1; step <= totalSteps; step++) {
                const validation = validateStep(step);
                if (!validation.isValid) {
                    currentStep = step;
                    showStep(currentStep);
                    break;
                }
            }
            
            e.preventDefault();
            return false;
        }
        
        console.log('=== FORM VALIDATION PASSED ===');
        
        // Log form data for debugging
        const formData = new FormData(this);
        console.log('Form data being submitted:');
        for (let [key, value] of formData.entries()) {
            if (value instanceof File) {
                console.log(key + ':', value.name, '(' + value.size + ' bytes)');
            } else {
                console.log(key + ':', value);
            }
        }
        
        return true;
    });
    
    // Real-time validation for input fields
    document.querySelectorAll('.form-control, .form-select').forEach(function(input) {
        if (input.type !== 'file') {
            input.addEventListener('blur', function() {
                validateField(this);
            });
            
            input.addEventListener('input', function() {
                if (this.classList.contains('is-invalid')) {
                    validateField(this);
                }
                
                // Hide errors summary when user starts fixing errors
                if (errorsSummary.classList.contains('show')) {
                    errorsSummary.classList.remove('show');
                }
            });
        }
    });

    function validateField(field) {
        const value = field.value.trim();
        
        // Remove existing validation classes
        field.classList.remove('is-valid', 'is-invalid');
        
        // Skip validation for non-required fields that are empty
        const isRequired = field.closest('.form-group')?.querySelector('.required');
        if (!isRequired && !value) {
            return;
        }
        
        // Email validation
        if (field.type === 'email' && value) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailRegex.test(value)) {
                field.classList.add('is-valid');
            } else {
                field.classList.add('is-invalid');
            }
            return;
        }
        
        // Required field validation
        if (isRequired) {
            if (!value) {
                field.classList.add('is-invalid');
            } else {
                field.classList.add('is-valid');
            }
        }
    }

    // Show server-side errors if any exist
    const serverErrors = document.querySelectorAll('.invalid-feedback:not(.js-error)');
    if (serverErrors.length > 0) {
        const errors = [];
        serverErrors.forEach(errorDiv => {
            const errorText = errorDiv.textContent.trim();
            if (errorText) {
                errors.push(errorText);
                // Mark the associated field as invalid
                const field = errorDiv.parentNode.querySelector('.form-control');
                if (field) {
                    field.classList.add('is-invalid');
                    if (field.type === 'file') {
                        field.closest('.file-upload-area')?.classList.add('has-error');
                    }
                }
            }
        });
        
        if (errors.length > 0) {
            errorsList.innerHTML = errors.map(error => `<li>${error}</li>`).join('');
            errorsSummary.classList.add('show');
        }
    }
    
    // Initialize
    showStep(1);
    setupFileUploads();
    
    console.log('=== INITIALIZATION COMPLETE ===');
});
</script>
{% endblock %}