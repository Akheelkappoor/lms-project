{% extends "base.html" %}

{% block title %}Export & Email Timetable{% endblock %}

{% block extra_css %}
<style>
    /* Modern export page styling */
    .main-content {
        margin-left: var(--sidebar-width) !important;
        width: calc(100% - var(--sidebar-width)) !important;
        padding: 0 !important;
        background: #f8f9fa;
        min-height: 100vh;
    }

    @media (max-width: 1024px) {
        .main-content {
            margin-left: 0 !important;
            width: 100% !important;
        }
    }

    .export-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .export-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        text-align: center;
    }

    .export-title {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
    }

    .export-subtitle {
        margin: 0.5rem 0 0 0;
        opacity: 0.9;
    }

    .export-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        overflow: hidden;
    }

    .panel-header {
        background: #f8f9fa;
        padding: 1.5rem;
        border-bottom: 1px solid #e9ecef;
    }

    .panel-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
        color: #2c3e50;
    }

    .panel-body {
        padding: 2rem;
    }

    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #374151;
    }

    .form-control, .form-select {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        background: white;
    }

    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .export-type-selector {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .export-type-card {
        padding: 1.5rem;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .export-type-card:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .export-type-card.active {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.05);
    }

    .export-type-icon {
        font-size: 2rem;
        margin-bottom: 1rem;
        color: #667eea;
    }

    .export-type-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #374151;
    }

    .export-type-desc {
        font-size: 0.875rem;
        color: #6b7280;
    }

    .preview-section {
        min-height: 400px;
        border: 2px dashed #d1d5db;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f9fafb;
        margin-bottom: 2rem;
    }

    .preview-placeholder {
        text-align: center;
        color: #6b7280;
    }

    .preview-content {
        width: 100%;
        height: 100%;
        overflow: auto;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .btn {
        padding: 0.75rem 2rem;
        border-radius: 8px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-primary:hover {
        background: #5a67d8;
        transform: translateY(-1px);
    }

    .btn-success {
        background: #48bb78;
        color: white;
    }

    .btn-success:hover {
        background: #38a169;
        transform: translateY(-1px);
    }

    .btn-info {
        background: #4299e1;
        color: white;
    }

    .btn-info:hover {
        background: #3182ce;
        transform: translateY(-1px);
    }

    .btn-outline {
        background: transparent;
        color: #667eea;
        border: 2px solid #667eea;
    }

    .btn-outline:hover {
        background: #667eea;
        color: white;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
    }

    .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .email-section {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        margin-top: 2rem;
    }

    .email-recipients {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        min-height: 100px;
        margin-bottom: 1rem;
    }

    .recipient-tag {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        margin: 0.25rem;
    }

    .notification {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: none;
    }

    .notification.success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
    }

    .notification.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }

    .notification.show {
        display: block;
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .export-container {
            padding: 1rem;
        }

        .export-type-selector {
            grid-template-columns: 1fr;
        }

        .filters-grid {
            grid-template-columns: 1fr;
        }

        .action-buttons {
            flex-direction: column;
        }
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
        transform: translateY(-1px);
    }
    
</style>
{% endblock %}

{% block content %}
<div class="export-container">
    <!-- Header -->
    <div class="export-header">
        <h1 class="export-title">üìä Export & Email Timetable</h1>
        <p class="export-subtitle">Generate and send customized timetables for students and tutors</p>
    </div>

    <!-- Notification Area -->
    <div id="notification" class="notification">
        <span id="notification-message"></span>
    </div>

    <!-- Export Type Selection -->
    <div class="export-panel">
        <div class="panel-header">
            <h2 class="panel-title">1. Select Export Type</h2>
        </div>
        <div class="panel-body">
            <div class="export-type-selector">
                <div class="export-type-card" data-type="student" onclick="selectExportType('student')">
                    <div class="export-type-icon">üë®‚Äçüéì</div>
                    <div class="export-type-title">Student Schedule</div>
                    <div class="export-type-desc">Beautiful calendar format for individual students</div>
                </div>
                <div class="export-type-card" data-type="tutor" onclick="selectExportType('tutor')">
                    <div class="export-type-icon">üë®‚Äçüè´</div>
                    <div class="export-type-title">Tutor Schedule</div>
                    <div class="export-type-desc">Detailed table format for tutors with multiple classes</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="export-panel">
        <div class="panel-header">
            <h2 class="panel-title">2. Set Filters & Date Range</h2>
        </div>
        <div class="panel-body">
            <div class="filters-grid">
                <!-- Date Range -->
                <div class="form-group">
                    <label class="form-label">üìÖ Start Date</label>
                    <input type="date" class="form-control" id="startDate" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üìÖ End Date</label>
                    <input type="date" class="form-control" id="endDate" required>
                </div>

                <!-- Quick Date Selectors -->
                <div class="form-group">
                    <label class="form-label">‚ö° Quick Select</label>
                    <select class="form-select" id="quickDate" onchange="setQuickDate(this.value)">
                        <option value="">Custom Range</option>
                        <option value="today">Today</option>
                        <option value="thisWeek">This Week</option>
                        <option value="nextWeek">Next Week</option>
                        <option value="thisMonth">This Month</option>
                        <option value="nextMonth">Next Month</option>
                    </select>
                </div>

                <!-- Student Selector (shown when student type selected) -->
                <div class="form-group" id="studentSelector" style="display: none;">
                    <label class="form-label">üë®‚Äçüéì Select Student</label>
                    <select class="form-select" id="studentId">
                        <option value="">Choose Student</option>
                        {% for student in students %}
                        <option value="{{ student.id }}">{{ student.full_name }} - Grade {{ student.grade or 'N/A' }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Tutor Selector (shown when tutor type selected) -->
                <div class="form-group" id="tutorSelector" style="display: none;">
                    <label class="form-label">üë®‚Äçüè´ Select Tutor</label>
                    <select class="form-select" id="tutorId">
                        <option value="">Choose Tutor</option>
                        {% for tutor in tutors %}
                        <option value="{{ tutor.id }}">{{ tutor.user.full_name if tutor.user else 'Unknown' }} - {{ tutor.user.department.name if tutor.user and tutor.user.department else 'No Dept' }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Additional Filters -->
                <div class="form-group">
                    <label class="form-label">üè¢ Department</label>
                    <select class="form-select" id="departmentId">
                        <option value="">All Departments</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}">{{ dept.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">üìö Subject</label>
                    <input type="text" class="form-control" id="subject" placeholder="Filter by subject (optional)">
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="generatePreview()" id="previewBtn">
                    <i class="fas fa-eye"></i>
                    Generate Preview
                </button>
            </div>
        </div>
    </div>

    <!-- Preview -->
    <div class="export-panel" id="previewPanel" style="display: none;">
        <div class="panel-header">
            <h2 class="panel-title">3. Preview</h2>
        </div>
        <div class="panel-body">
            <div class="preview-section" id="previewSection">
                <div class="preview-placeholder">
                    <i class="fas fa-eye fa-3x" style="color: #d1d5db;"></i>
                    <p>Click "Generate Preview" to see your timetable</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Download & Email Actions -->
    <div class="export-panel" id="actionsPanel" style="display: none;">
        <div class="panel-header">
            <h2 class="panel-title">4. Download & Email</h2>
        </div>
        <div class="panel-body">
            <!-- Download Section -->
            <div class="action-buttons">
                <button class="btn btn-success" onclick="downloadExport('html')" id="downloadHtmlBtn">
                    <i class="fas fa-download"></i>
                    Download HTML
                </button>
                <button class="btn btn-danger" onclick="downloadExport('pdf')" id="downloadPdfBtn">
                    <i class="fas fa-file-pdf"></i>
                    Download PDF
                </button>
                <button class="btn btn-info" onclick="downloadExport('csv')" id="downloadCsvBtn">
                    <i class="fas fa-file-csv"></i>
                    Download CSV
                </button>
                <button class="btn btn-outline" onclick="showEmailSection()" id="emailBtn">
                    <i class="fas fa-envelope"></i>
                    Send Email
                </button>
            </div>

            <!-- Email Section -->
            <div class="email-section" id="emailSection" style="display: none;">
                <div class="form-group">
                    <label class="form-label">üìß Email Recipients</label>
                    <input type="email" class="form-control" id="emailInput" placeholder="Enter email address and press Enter" onkeypress="addEmailRecipient(event)">
                    <div class="email-recipients" id="emailRecipients">
                        <p style="color: #6b7280; font-size: 0.875rem;">Add email addresses above. Press Enter to add each one.</p>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="sendEmail()" id="sendEmailBtn">
                        <i class="fas fa-paper-plane"></i>
                        Send Email
                    </button>
                    <button class="btn btn-outline" onclick="hideEmailSection()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentExportType = '';
let emailRecipients = [];
let previewData = null;

// Set default dates
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
    
    document.getElementById('startDate').value = today.toISOString().split('T')[0];
    document.getElementById('endDate').value = nextWeek.toISOString().split('T')[0];
});

function selectExportType(type) {
    currentExportType = type;
    
    // Update UI
    document.querySelectorAll('.export-type-card').forEach(card => {
        card.classList.remove('active');
    });
    document.querySelector(`[data-type="${type}"]`).classList.add('active');
    
    // Show/hide appropriate selectors
    if (type === 'student') {
        document.getElementById('studentSelector').style.display = 'block';
        document.getElementById('tutorSelector').style.display = 'none';
    } else {
        document.getElementById('studentSelector').style.display = 'none';
        document.getElementById('tutorSelector').style.display = 'block';
    }
    
    // Clear previous preview
    clearPreview();
}

function setQuickDate(value) {
    const today = new Date();
    let startDate, endDate;
    
    switch(value) {
        case 'today':
            startDate = endDate = today;
            break;
        case 'thisWeek':
            startDate = new Date(today.setDate(today.getDate() - today.getDay() + 1)); // Monday
            endDate = new Date(today.setDate(today.getDate() - today.getDay() + 7)); // Sunday
            break;
        case 'nextWeek':
            startDate = new Date(today.setDate(today.getDate() - today.getDay() + 8)); // Next Monday
            endDate = new Date(today.setDate(today.getDate() - today.getDay() + 14)); // Next Sunday
            break;
        case 'thisMonth':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            break;
        case 'nextMonth':
            startDate = new Date(today.getFullYear(), today.getMonth() + 1, 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 2, 0);
            break;
        default:
            return;
    }
    
    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
}

async function generatePreview() {
    if (!validateForm()) return;
    
    const btn = document.getElementById('previewBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<div class="loading-spinner"></div> Generating...';
    btn.disabled = true;
    
    try {
        const data = getFormData();
        
        const response = await fetch('/admin/api/v1/export/preview', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            previewData = result;
            showPreview(result.preview_html);
            showNotification(`Preview generated successfully! Found ${result.class_count} classes.`, 'success');
        } else {
            showNotification(result.error, 'error');
        }
        
    } catch (error) {
        showNotification('Error generating preview: ' + error.message, 'error');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

function showPreview(html) {
    document.getElementById('previewSection').innerHTML = html;
    document.getElementById('previewPanel').style.display = 'block';
    document.getElementById('actionsPanel').style.display = 'block';
    
    // Scroll to preview
    document.getElementById('previewPanel').scrollIntoView({ behavior: 'smooth' });
}

function clearPreview() {
    document.getElementById('previewPanel').style.display = 'none';
    document.getElementById('actionsPanel').style.display = 'none';
    previewData = null;
}

async function downloadExport(format) {
    if (!previewData) {
        showNotification('Please generate a preview first', 'error');
        return;
    }
    
    // Get the correct button based on format
    let btn;
    if (format === 'html') {
        btn = document.getElementById('downloadHtmlBtn');
    } else if (format === 'csv') {
        btn = document.getElementById('downloadCsvBtn');
    } else if (format === 'pdf') {
        btn = document.getElementById('downloadPdfBtn');
    }
    
    if (!btn) {
        showNotification('Download button not found', 'error');
        return;
    }
    
    const originalText = btn.innerHTML;
    btn.innerHTML = '<div class="loading-spinner"></div> Downloading...';
    btn.disabled = true;
    
    try {
        const data = getFormData();
        
        // Use different endpoint for PDF downloads
        let endpoint;
        if (format === 'pdf') {
            endpoint = '/admin/api/v1/export/download-pdf';
        } else {
            endpoint = `/admin/api/v1/export/download/${format}`;
        }
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // Generate proper filename with timestamp
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:]/g, '').replace('T', '_');
            let filename;
            
            if (previewData.export_type === 'student') {
                const studentName = previewData.student_name ? previewData.student_name.replace(/[^a-zA-Z0-9]/g, '_') : 'student';
                filename = `student_timetable_${studentName}_${timestamp}.${format}`;
            } else if (previewData.export_type === 'tutor') {
                const tutorName = previewData.tutor_name ? previewData.tutor_name.replace(/[^a-zA-Z0-9]/g, '_') : 'tutor';
                filename = `tutor_timetable_${tutorName}_${timestamp}.${format}`;
            } else {
                filename = `timetable_${timestamp}.${format}`;
            }
            
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification(`${format.toUpperCase()} file downloaded successfully!`, 'success');
        } else {
            const result = await response.json();
            showNotification(result.error || 'Download failed', 'error');
        }
        
    } catch (error) {
        showNotification('Error downloading file: ' + error.message, 'error');
        console.error('Download error:', error);
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

function showEmailSection() {
    document.getElementById('emailSection').style.display = 'block';
    document.getElementById('emailInput').focus();
}

function hideEmailSection() {
    document.getElementById('emailSection').style.display = 'none';
    emailRecipients = [];
    updateEmailRecipients();
}

function addEmailRecipient(event) {
    if (event.key === 'Enter') {
        const email = event.target.value.trim();
        if (email && isValidEmail(email) && !emailRecipients.includes(email)) {
            emailRecipients.push(email);
            updateEmailRecipients();
            event.target.value = '';
        }
    }
}

function removeEmailRecipient(email) {
    emailRecipients = emailRecipients.filter(e => e !== email);
    updateEmailRecipients();
}

function updateEmailRecipients() {
    const container = document.getElementById('emailRecipients');
    if (emailRecipients.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; font-size: 0.875rem;">Add email addresses above. Press Enter to add each one.</p>';
    } else {
        container.innerHTML = emailRecipients.map(email => 
            `<span class="recipient-tag">${email} <i class="fas fa-times" onclick="removeEmailRecipient('${email}')" style="cursor: pointer; margin-left: 0.5rem;"></i></span>`
        ).join('');
    }
}

async function sendEmail() {
    if (emailRecipients.length === 0) {
        showNotification('Please add at least one email recipient', 'error');
        return;
    }
    
    if (!previewData) {
        showNotification('Please generate a preview first', 'error');
        return;
    }
    
    const btn = document.getElementById('sendEmailBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<div class="loading-spinner"></div> Sending...';
    btn.disabled = true;
    
    try {
        const data = getFormData();
        data.recipients = emailRecipients;
        
        const response = await fetch('/admin/api/v1/export/email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(result.message, 'success');
            hideEmailSection();
        } else {
            showNotification(result.error, 'error');
        }
        
    } catch (error) {
        showNotification('Error sending email: ' + error.message, 'error');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

function validateForm() {
    if (!currentExportType) {
        showNotification('Please select an export type (Student or Tutor)', 'error');
        return false;
    }
    
    if (!document.getElementById('startDate').value || !document.getElementById('endDate').value) {
        showNotification('Please select start and end dates', 'error');
        return false;
    }
    
    if (currentExportType === 'student' && !document.getElementById('studentId').value) {
        showNotification('Please select a student', 'error');
        return false;
    }
    
    if (currentExportType === 'tutor' && !document.getElementById('tutorId').value) {
        showNotification('Please select a tutor', 'error');
        return false;
    }
    
    return true;
}

function getFormData() {
    return {
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        student_id: currentExportType === 'student' ? document.getElementById('studentId').value : null,
        tutor_id: currentExportType === 'tutor' ? document.getElementById('tutorId').value : null,
        department_id: document.getElementById('departmentId').value || null,
        subject: document.getElementById('subject').value || null
    };
}

function showNotification(message, type) {
    const notification = document.getElementById('notification');
    const messageEl = document.getElementById('notification-message');
    
    messageEl.textContent = message;
    notification.className = `notification ${type} show`;
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 5000);
}

function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}
</script>
{% endblock %}